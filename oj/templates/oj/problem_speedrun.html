{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{{ problem.title }} - {% trans "Speedrun" %}{% endblock %}

{% block content %}
<div class="container my-4">

    <h1 class="display-5 text-center mb-4">{{ problem.title }} - {% trans "Speedrun Mode" %}</h1>

    <div class="mb-3 d-flex gap-2">
        <a href="{% url 'problem_detail' problem.id %}" class="btn btn-outline-success">
            {% trans "Back to Practice Mode" %}
        </a>
        <a href="{% url 'problem_leaderboard' problem.id %}" class="btn btn-outline-primary">
            {% trans "View Leaderboard" %}
        </a>
    </div>

    <div class="card shadow mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5>{% trans "Speedrun Editor(copy&paste are banned)" %}</h5>
                <div id="timer" class="h5 text-danger m-0">Time: 0.00 s</div>
            </div>

            <!-- æç¤ºå¿«æ·é”® -->
            <p class="text-muted mb-2" style="font-size: 0.9rem;">
                ğŸ’¡ {% trans "Tip:" %} {% trans "Press Ctrl + Enter (or âŒ˜ + Enter on Mac) to submit your code instantly." %}
            </p>

            <form method="post" id="speedrun-form" novalidate>
                {% csrf_token %}
                <div class="mb-2 d-flex gap-2">
                    <select name="language" class="form-select w-auto" id="lang-select">
                        <option value="cpp">C++</option>
                        <option value="py">Python</option>
                    </select>
                    <button type="submit" class="btn btn-primary">{% trans "Submit" %}</button>
                </div>

                <!-- Monaco Editor Container -->
                <div id="speedrun-editor" style="height: 400px; border: 1px solid #ccc;"></div>
                <textarea id="code-hidden" name="code" hidden></textarea>
                <input type="hidden" name="elapsed_time" id="elapsed-time" value="0">
                <input type="hidden" name="kpm" id="kpm-input" value="0">
            </form>
        </div>
    </div>

    <!-- Problem Description Card -->
    <div class="card shadow">
        <div class="card-body">
            <p class="lead">{{ problem_content|safe }}</p>
            <p class="text-muted">
                <strong>{% trans "Time Limit:" %}</strong> {{ problem.time_limit }}s
                &nbsp; | &nbsp;
                <strong>{% trans "Memory Limit:" %}</strong> {{ problem.memory_limit }} MB
            </p>
        </div>
    </div>

</div>

<!-- å¼•å…¥ Monaco -->
<script src="https://cdn.jsdelivr.net/npm/monaco-editor@latest/min/vs/loader.js"></script>
<script>
(function(){
    const langSelect = document.getElementById("lang-select");
    const form = document.getElementById("speedrun-form");
    const codeHidden = document.getElementById("code-hidden");
    const elapsedInput = document.getElementById("elapsed-time");
    const kpmInput = document.getElementById("kpm-input");
    const timerDisplay = document.getElementById("timer");

    let startTime = null;
    let timerInterval = null;
    let keystrokeCount = 0;

    require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@latest/min/vs' }});

    require(['vs/editor/editor.main'], function () {
        let editor = monaco.editor.create(document.getElementById('speedrun-editor'), {
            value: '',
            language: 'cpp',
            theme: 'vs',
            automaticLayout: true,
            fontSize: 14,
            minimap: { enabled: false }
        });

        // ç¦æ­¢å¤åˆ¶/ç²˜è´´/æ‹–æ‹½
        const preventDefault = (e) => { e.preventDefault(); e.stopImmediatePropagation(); };
        editor.onKeyDown(e => {
            if ((e.ctrlKey || e.metaKey) && ['c','v','x'].includes(e.browserEvent.key.toLowerCase())) preventDefault(e.browserEvent);

            // ç»Ÿè®¡ KPMï¼ˆå¿½ç•¥åŠŸèƒ½é”®ï¼‰
            const ignoredKeys = [
                monaco.KeyCode.Control, monaco.KeyCode.Shift, monaco.KeyCode.Alt,
                monaco.KeyCode.Meta, monaco.KeyCode.LeftArrow, monaco.KeyCode.RightArrow,
                monaco.KeyCode.UpArrow, monaco.KeyCode.DownArrow
            ];
            if (!ignoredKeys.includes(e.keyCode)) keystrokeCount++;
        });
        editor.onDidPaste(preventDefault);
        editor.onDidBlurEditorWidget(preventDefault);

        // åˆ‡æ¢è¯­è¨€
        langSelect.addEventListener('change', function(){
            const newLang = (this.value === 'cpp') ? 'cpp' : 'python';
            monaco.editor.setModelLanguage(editor.getModel(), newLang);
        });

        // è®¡æ—¶å™¨ï¼šç¬¬ä¸€æ¬¡ä¿®æ”¹å¼€å§‹
        editor.onDidChangeModelContent(() => {
            if(startTime === null){
                startTime = Date.now();
                timerInterval = setInterval(()=>{
                    const elapsed = (Date.now() - startTime)/1000;
                    timerDisplay.textContent = `Time: ${elapsed.toFixed(2)} s`; // åªæ˜¾ç¤ºæ—¶é—´
                    elapsedInput.value = elapsed.toFixed(3);
                }, 100);
            }
        });

        // æäº¤å‰åŒæ­¥å†…å®¹å’Œ elapsed_time/kpm
        const submitHandler = function() {
            codeHidden.value = editor.getValue();
            if(startTime !== null){
                const elapsed = (Date.now() - startTime)/1000;
                elapsedInput.value = elapsed.toFixed(3);
                const minutes = elapsed / 60;
                kpmInput.value = minutes > 0 ? (keystrokeCount / minutes).toFixed(0) : 0;
            } else {
                elapsedInput.value = 0;
                kpmInput.value = 0;
            }
            if(timerInterval) clearInterval(timerInterval);
        };

        form.addEventListener('submit', submitHandler);

        // Ctrl/Cmd + Enter å¿«æ·é”®æäº¤
        editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.Enter, submitHandler);
    });
})();
</script>
{% endblock %}
