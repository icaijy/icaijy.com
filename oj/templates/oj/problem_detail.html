{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{{ problem.title }} - {% trans "OJ" %}{% endblock %}

{% block content %}
<div class="container my-4">
  <h1 class="display-5 text-center mb-4">{{ problem.title }}</h1>

  <div class="card shadow mb-4">
    <div class="card-body">
      <p class="lead">{{ problem_content|safe }}</p>
      <p class="text-muted">
        <strong>{% trans "Time Limit:" %}</strong> {{ problem.time_limit }}s
        &nbsp; | &nbsp;
        <strong>{% trans "Memory Limit:" %}</strong> {{ problem.memory_limit }} MB
      </p>

      <div class="mt-3">
        <a href="{% url 'problem_speedrun' problem.id %}" class="text-success fw-bold fs-5">
          {% trans "Go to speedrun page!!" %}
        </a>
      </div>
    </div>
  </div>

  <!-- Practice Editor -->
  <div class="card shadow mb-4">
    <div class="card-body">
      <h5 class="mb-3">{% trans "Practice Mode" %}</h5>

      <form method="post" id="submission-form" novalidate>
        {% csrf_token %}
        <div class="mb-2 d-flex">
          <select name="language" class="form-select me-2" id="lang-select">
            <option value="cpp">C++</option>
            <option value="py">Python</option>
          </select>
          <button type="submit" class="btn btn-primary flex-shrink-0">{% trans "Submit" %}</button>
        </div>

        <!-- Monaco Editor 容器 -->
        <div id="practice-editor" style="height: 400px; border: 1px solid #ccc;"></div>

        <!-- 隐藏 textarea 存 Monaco 内容 -->
        <textarea id="code-hidden" name="code" hidden></textarea>
        <input type="hidden" name="elapsed_time" value="-1">
      </form>
    </div>
  </div>
</div>

<!-- 引入 Monaco -->
<script src="https://cdn.jsdelivr.net/npm/monaco-editor@latest/min/vs/loader.js"></script>
<script>
(function(){
  const langSelect = document.getElementById("lang-select");
  const form = document.getElementById("submission-form");
  const codeHidden = document.getElementById("code-hidden");

  // Monaco loader config
  require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@latest/min/vs' }});

  require(['vs/editor/editor.main'], function () {
    // 初始化 Monaco
    let editor = monaco.editor.create(document.getElementById('practice-editor'), {
      value: '',
      language: 'cpp',
      theme: 'vs',
      automaticLayout: true,
      fontSize: 14,
      minimap: { enabled: false }
    });

    // 切换语言
    langSelect.addEventListener('change', function(){
      const newLang = (this.value === 'cpp') ? 'cpp' : 'python';
      monaco.editor.setModelLanguage(editor.getModel(), newLang);
    });

    // 提交前同步内容到隐藏 textarea
    form.addEventListener('submit', function(){
      codeHidden.value = editor.getValue();
    });
  });
})();
</script>
{% endblock %}
